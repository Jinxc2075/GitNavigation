local EventDispatcher = require("event/EventDispatcher")
local csEventControllerInst = CS.EventController.inst
local csGameEventType = CS.GameEventType
local Vector3 = CS.UnityEngine.Vector3

xlua.private_accessible(CS.ExploreSlotItem)
xlua.hotfix(
	CS.ExploreSlotItem,
	"UpdateState",
	function(self, _data)

		self.data = _data
		if (self.data.exploreState == 0) then
			self:InitData(self.data.slotId)
			return
		end
		self.index = self.data.slotId
		self.slotState = CS.kExploreSlotState.__CastFrom(self.data.exploreState)
		local tempData = CS.ExploreInstanceConfigManager.inst:GetConfig(self.data.exploreId)
		self.refugeBgImg.enabled = self.data.slotType == 2
		if (self.data.slotType == 0 or self.data.slotType == 1 or self.data.slotType == 3) then

			self.coolBg.enabled = true
			self.refugeCoolBg.enabled = false
			self.refugeBgImg.enabled = false
			self.icon.gameObject:SetActive(true)
			self.refugeIcon.gameObject:SetActive(false)

			local bgIcon = self.gameObject:GetComponent("GUIIcon")
			local coolIcon = self.coolBg.gameObject:GetComponent("GUIIcon")

			if(self.data.slotType == 0 or self.data.slotType == 1) then
				bgIcon:SetSprite("main_atlas","tanxian_tubiaodi")
				coolIcon:SetSprite("main_atlas","tanxian_tubiaojiuxu")

				local group = CS.ExploreDataProxy.inst:GetGroupDataByGroupId(tempData.instance_group)
				self:setIconData(tempData, group)
			elseif self.data.slotType == 3 then
				if(tempData ~= nil)then

					if(tempData.instance_type == 2)then
						local goldenCityCfg = nil
						if(GoldenCityDataProxy.inst.bossExploreIsAllOver)then
							goldenCityCfg = GoldenCityConfigManager:GetLastBossConfig()
						else
							goldenCityCfg = GoldenCityDataProxy.inst.bossExploreCfg
						end

						if(goldenCityCfg ~= nil)then
							self.icon.gameObject:SetActive(true)

							local keyItemCfg = CS.ItemconfigManager.inst:GetConfig(goldenCityCfg.ic_id)

							if(keyItemCfg ~= nil)then
								self.icon:SetSprite(keyItemCfg.atlas,keyItemCfg.icon)
							else
								self.icon.gameObject:SetActive(false)
							end
						else
							self.icon.gameObject:SetActive(false)
						end
					else

						local itemWdpCfg = CS.WorldParConfigManager.inst:GetConfig(8403)
						if(itemWdpCfg ~= nil)then
							local itemCfg = CS.ItemconfigManager.inst:GetConfig(itemWdpCfg.parameters)
							if(itemCfg ~= nil)then
								self.icon.gameObject:SetActive(true)

								self.icon:SetSprite(itemCfg.atlas,itemCfg.icon)
							else
								self.icon.gameObject:SetActive(false)
							end
						else
							self.icon.gameObject:SetActive(false)
						end

					end

				end

				bgIcon:SetSprite("goldenCity_atlas","tanxian_huodongdi")
				coolIcon:SetSprite("goldenCity_atlas","tanxian_huodongdi1")
			end

		elseif self.data.slotType == 2 then

			self.coolBg.enabled = false
			self.refugeCoolBg.enabled = true
			self.refugeBgImg.enabled = true
			self.icon.gameObject:SetActive(false)
			self.refugeIcon.gameObject:SetActive(true)
			self:setRefugeIcon()
		end
		if (self.data.exploreState == 1) then

			self.liuguangcrl.enabled = false
			self.timeText.fontSize = 32
			self.timeText.color = CS.UnityEngine.Color.white

			self.coolBg.fillAmount = 1 - self.data.exploringRemainTime / self.data.exploreTotalTime
			self.refugeCoolBg.fillAmount = 1 - self.data.exploringRemainTime / self.data.exploreTotalTime

			self:StartExplore()

		elseif self.data.exploreState == 2 then

			if (self.timerId > 0) then

				CS.GameTimer.inst:RemoveTimer(self.timerId)
				self.timerId = 0
			end
			self.timeText.text = CS.LanguageManager.inst:GetValueByKey("就绪")
			self.timeText.fontSize = 38
			self.timeText.color = CS.GUIHelper.GetColorByColorHex("#ffd907")
			self.liuguangcrl.enabled = true
			self.coolBg.fillAmount = 1
			self.refugeCoolBg.fillAmount = 1
			self.timeText.rectTransform:DOScale(1, 0.5):From(1.3):SetEase(CS.DG.Tweening.Ease.InOutQuad):SetLoops(-1, CS.DG.Tweening.LoopType.Yoyo)

			--self.fillTweenImg:DOFade(0.4,0.8):From(0):SetLoops(-1,CS.DG.Tweening.LoopType.Yoyo);
		end

	end
)

xlua.hotfix(
	CS.ExploreSlotItem,
	"onSlotBtnClick",
	function(self)
		if (self.slotState == CS.kExploreSlotState.Exploring) then

			if (self.data == nil) then return end
			if (self.data.slotType == 0 or self.data.slotType == 1) then
				local funcGeneric = xlua.get_generic_method(CS.EventController, "TriggerEvent_Lua1")
				local func = funcGeneric(CS.System.Int32)
				func(csEventControllerInst, csGameEventType.ExploreEvent.ROLEADVENTUREBYSLOT_SHOWUI, self.data.slotId)
			elseif self.data.slotType == 2 then
				EventDispatcher:dispatchEvent(GameEvent.RefugeEvent.ShowUI_RefugeAdventure,self.data.slotId)
			elseif self.data.slotType == 3 then
				EventDispatcher:dispatchEvent(GameEvent.GoldenCityEvent.OpenUI_GoldenCityAdventure,self.data.slotId)
			end
		elseif self.slotState == CS.kExploreSlotState.Finish then

			if(self.timeText ~= nil) then
				CS.DG.Tweening.DOTween.Kill(self.timeText.rectTransform)
				self.timeText.transform.localScale = Vector3.one
			end
			if (self.data == nil) then return end
			if (self.data.slotType == 0 or self.data.slotType == 1) then
				local funcGeneric = xlua.get_generic_method(CS.EventController, "TriggerEvent_Lua1")
				local func = funcGeneric(CS.System.Int32)
				func(csEventControllerInst, csGameEventType.ExploreEvent.REQUEST_EXPLOREEND, self.index)
			elseif self.data.slotType == 2 then
				EventDispatcher:dispatchEvent(GameEvent.RefugeEvent.Request_RefugeEnd,self.data.slotId)
			elseif self.data.slotType == 3 then
				CS.GUIManager.BackMainView()
				EventDispatcher:dispatchEvent(GameEvent.GoldenCityEvent.Request_GoldenCity_ExploreEnd,self.data.slotId)
			end
			self.data = nil
		end

	end
)