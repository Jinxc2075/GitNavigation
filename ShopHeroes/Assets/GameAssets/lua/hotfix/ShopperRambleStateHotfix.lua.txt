
require("utils/XLuaUtils")

local CS_LanguageManagerInst = CS.LanguageManager.inst
local CS_AITalkConfigManagerInst = CS.AITalkConfigManager.inst
local CS_UserDataProxyInst = CS.UserDataProxy.inst

--ShopperRambleStateHotfix C#已经同步逻辑 新包需要


xlua.private_accessible(CS.ShopperRambleState)

xlua.hotfix(
	CS.ShopperRambleState,
	"shopperRambleEndComplete",
	function(self)


		local equipUid = self._shopper.rambleTargetEquipUid;
		local equipId = self._shopper.rambleTargetEquipId == 0 and self._shopper.shopperData.data.targetEquipId or self._shopper.rambleTargetEquipId;


		if self._shopper.rambleTargetShelfUid == -1 and not self.notHaveTargetShelfStates:Contains(self._shopper.rambleType) then --目标地点到不了

			self._shopper.rambleTalkeCountLimit = -1;
			self._shopper:Talk(CS_LanguageManagerInst:GetValueByKey(CS_AITalkConfigManagerInst:GetRandomTalk(self._shopper.shopperData.data.shopperId, self._shopper.shopperData.data.shopperLevel, CS.TalkConditionType.shopper_cantMoveToTargetShelf)));

			if (self._shopper.rambleCanMovePathNodeNum ~= 0) then

				if CS.Helper.randomResult(CS.WorldParConfigManager.inst:GetConfig(1106).parameters) then

					equipUid = self._shopper.shopperData.data.targetEquipUid;
					equipId = self._shopper.shopperData.data.targetEquipId;
				end

				--else --整条路到不了 直接走人

			end

		end


		local rep = MsgType.Request_Shopper_Queue:New()
		rep.shopperUid = self._shopper.shopperUid
		--rep.equipUid =
		rep.equipId = equipId
		rep:Send()


		self:shopperQueueError()

	end
)

xlua.hotfix(
	CS.ShopperRambleState,
	"notHave_ramble_1", --变更原需求 仅Lua修改
	function (self)

		local furnitures = get_csharp_list(CS.System.Int32)
		furnitures:AddRange(CS_UserDataProxyInst:GetRanShelfUids(math.random(1,3)))

		local pathDatas = get_csharp_list(CS.Shopper_PathData)
		for i = 0, furnitures.Count - 1 do
			pathDatas:Add(CS.Shopper_PathData(0,furnitures[i]))
		end

		self._shopper:EstablishedLine(pathDatas,0,function (pathData)
				self._shopper:MoveToPathNodeBehavior(pathData)
			end,function ()
				self:shopperRambleEndComplete()
			end)

	end
)


