
--SevenDayBuyPassUI 大亨通行证购买界面（七日）

local CS_type_ObjList = typeof(CS.ObjList)
local CS_type_LuaBehaviour = typeof(CS.LuaBehaviour)
local CS_type_superList = typeof(CS.Mosframe.DynamicScrollView)
local CS_type_LuaListItem = typeof(CS.LuaListItem)

local CS_GameTimerInst = CS.GameTimer.inst
local CS_PayInst = CS.GamePay.inst
local CS_SevenDayGoalDataProxyInst = CS.SevenDayGoalDataProxy.inst

local CS_LanguageManagerInst = CS.LanguageManager.inst
local CS_WorldParConfigManagerInst = CS.WorldParConfigManager.inst
local CS_UserDataProxyInst = CS.UserDataProxy.inst

require("const/Constants")
require("class")
require("ui/ViewBase")
require("utils/XLuaUtils")
local EventDispatcher = require("event/EventDispatcher")

SevenDayBuyPassUI = class(ViewBase)

function SevenDayBuyPassUI:ctor()
	self.viewID = Constants.ViewName.SevenDayBuyPassUI
	SevenDayBuyPassUI.super.init(self, self.viewID)
	self.sortingLayerName = "window"
	self.isShowResPanel = false
	--self.topResPanelType = CS.TopPlayerShowType.noRoleAndSettingAndEnergy
end
------------------------------------------------


function SevenDayBuyPassUI:initComp()

	local contentPane = self.contentPanel

	self.btn_close = contentPane:GetButton("btn_close")
	self.btn_mask = contentPane:GetButton("btn_mask")
	self.superList_awards = contentPane:GetObjByName("superList_awards"):GetComponent(CS_type_superList)
	self.btn_buy = contentPane:GetButton("btn_buy")
	self.tx_buy = contentPane:GetText("tx_buy")
	self.tx_gameCost = contentPane:GetText("tx_gameCost")
	
	self.uiAnimator = contentPane.uiAnimator

end

function SevenDayBuyPassUI:onInit()

	self:initComp()

	self.payType = 0; --0充值 1金条
	self.listItemCount = 0

	self.btn_close:ButtonClickTween(function ()
			self:hide()
		end)

	self.btn_mask.onClick:AddListener(function ()
			self:hide()
		end)
	
	self.superList_awards.itemRenderer = function(index,item)
		self:superListItemRenderer(index,item)
	end

	self.superList_awards.itemUpdateInfo = function(index,item)
		self:superListItemRenderer(index,item)
	end
	
	self.btn_buy:ButtonClickTween(function ()
			self:onBuyBtnClick()
		end)

end

function SevenDayBuyPassUI:superListItemRenderer(index,item)
	
	local objList = item.transform:GetComponent(CS_type_ObjList).objList

	for i = 0, 4 - 1 do

		local itemIndex = index * 4 + i

		if 	itemIndex < self.listItemCount then

			objList[i].gameObject:SetActive(true)

			objList[i].gameObject:GetComponent(CS_type_LuaListItem):SetData(itemIndex + 1)

		else

			objList[i].gameObject:SetActive(false)

		end

	end
	
end

function SevenDayBuyPassUI:setListItemTotalCount(count)

	if count < 0 then
		count = 0
	end

	self.listItemCount = count

	local num = math.floor(count / 4)

	if count % 4 > 0 then
		num = num + 1
	end

	self.superList_awards.totalItemCount = num

end

function SevenDayBuyPassUI:onShowed()

	local worldParCfg =  CS_WorldParConfigManagerInst:GetConfig(8021)

	if worldParCfg ~= nil and worldParCfg.parameters == 1 then --充值

		self.payType = 0
		self.tx_buy.text = CS_PayInst:GetProductPrice(CS_SevenDayGoalDataProxyInst.sevenDayPassPayProduct.productId)
		self.tx_gameCost.gameObject:SetActive(false)

	else --金条

		self.payType = 1
		self.tx_buy.text = ""
		self.tx_gameCost.gameObject:SetActive(true)
		
		worldParCfg = CS_WorldParConfigManagerInst:GetConfig(8022)
		if worldParCfg ~= nil then
			self.tx_gameCost.text = tostring(math.ceil(worldParCfg.parameters))
			self.tx_gameCost.color = worldParCfg.parameters > CS_UserDataProxyInst.playerData.gem and CS.GUIHelper.GetColorByColorHex("FFFFFF") or CS.GUIHelper.GetColorByColorHex("FF2828")
		else
			self.tx_gameCost.text = "WorldParConfig Error"
		end

	end
	
	self:setListItemTotalCount(SevenDayPassAwardConfigManager:GetAwardsCount())

end

function SevenDayBuyPassUI:onBuyBtnClick()

	if self.payType == 0 then

		CS_PayInst:Pay(
			CS_SevenDayGoalDataProxyInst.sevenDayPassPayProduct.priceId,
			CS_SevenDayGoalDataProxyInst.sevenDayPassPayProduct.productId,
			CS_SevenDayGoalDataProxyInst.sevenDayPassPayProduct.payActivityType,
			CS_SevenDayGoalDataProxyInst.sevenDayPassPayProduct.payActivityId,
			function(isSuccess)
				if (isSuccess) then
					--print("充值成功")

				end
			end
		)

	else
		
		local worldParCfg = CS_WorldParConfigManagerInst:GetConfig(8022)
		
		if worldParCfg == nil or worldParCfg.parameters > CS_UserDataProxyInst.playerData.gem then
			EventDispatcher:dispatchEvent(GameEvent.MsgTipEvent.ShowTextMsgTip,CS_LanguageManagerInst:GetValueByKey("金条不足"),"FF2828")
		end

		EventDispatcher:dispatchEvent(GameEvent.MallEvent.REQUEST_PAYIOSBUY,CS_SevenDayGoalDataProxyInst.sevenDayPassPayProduct.priceId,CS_SevenDayGoalDataProxyInst.sevenDayPassPayProduct.payActivityType,CS_SevenDayGoalDataProxyInst.sevenDayPassPayProduct.payActivityId)

	end

end


function SevenDayBuyPassUI:DoShowAnimation()

	self:onShowed()

	self.uiAnimator:CrossFade("show", 0)
	self.uiAnimator:Update(0)
	self.uiAnimator:Play("show")

end

function SevenDayBuyPassUI:DoHideAnimation()

	self.uiAnimator:Play("hide")
	local animLength = self.uiAnimator:GetClipLength("common_popUpUI_hide")

	CS_GameTimerInst:AddTimer(
		animLength,
		1,
		function()
			self.uiAnimator:CrossFade("null", 0)
			self.uiAnimator:Update(0)
			self:HideView()
		end
	)

end


function SevenDayBuyPassUI:onHide()

end