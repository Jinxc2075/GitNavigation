

local EventDispatcher = require("event/EventDispatcher")
local CS_type_LuaBehaviour = typeof(CS.LuaBehaviour)
local csWorldParConfigManagerInst = CS.WorldParConfigManager.inst
local csEventControllerInst = CS.EventController.inst
local csGameEventType = CS.GameEventType
local csGUIHelper = CS.GUIHelper


--RoleRecruitBar_dlc


local RoleRecruitBar_dlc = class()

function RoleRecruitBar_dlc:ctor()

	self.isInitComp = false

end

function RoleRecruitBar_dlc:initComp(obj)

	self.gameObject = obj
	self.transform = obj.transform
	self.contentPane = obj:GetComponent(CS_type_LuaBehaviour)

	self.itemBtn = self.contentPane:GetButton("itemBtn")
	self.itemNumText = self.contentPane:GetText("itemNumText")
	self.itemIcon = self.contentPane:GetGUIIcon("itemIcon")

	self.isInitComp = true

	self.itemBtn:ButtonClickTween(function ()
			self:clickItemRefreshBtn()
		end)

end

function RoleRecruitBar_dlc:init(obj)

	self:initComp(obj)
	self:addListeners()

end

xlua.private_accessible(CS.RoleRecruitBarView)
function RoleRecruitBar_dlc:addListeners()

	EventDispatcher:addEvent(GameEvent.HeroEvent.RefreshUI_RoleRecruitBar,self,self.refreshRoleRecruitInfo)


end


function RoleRecruitBar_dlc:removeListeners()

	EventDispatcher:removeEvent(GameEvent.HeroEvent.RefreshUI_RoleRecruitBar,self,self.refreshRoleRecruitInfo)


end

function RoleRecruitBar_dlc:refreshRoleRecruitInfo()

	if self.isInitComp then

		local wdpCfg = csWorldParConfigManagerInst:GetConfig(306)
		if(wdpCfg ~= nil)then
			local itemCfg = CS.ItemconfigManager.inst:GetConfig(wdpCfg.parameters)

			if(itemCfg ~= nil)then
				self.itemIcon.iconImage.enabled = true
				self.itemIcon:SetSprite(itemCfg.atlas, itemCfg.icon)
			else
				self.itemIcon.iconImage.enabled = false
			end
			if(CS.ItemBagProxy.inst:resItemCount(wdpCfg.parameters) > 0)then
				self.itemNumText.text = tostring(math.ceil(CS.ItemBagProxy.inst:resItemCount(wdpCfg.parameters))) .. "/1"
			else
				self.itemNumText.text = "<Color=#FF0000>" .. tostring(math.ceil(CS.ItemBagProxy.inst:resItemCount(wdpCfg.parameters))) .. "</Color>" .. "/1"
			end
		end

	end

end

function RoleRecruitBar_dlc:clickItemRefreshBtn()

	if self.isInitComp then

		local wdpCfg = csWorldParConfigManagerInst:GetConfig(306)
		if(wdpCfg ~= nil)then

			if(CS.ItemBagProxy.inst:resItemCount(wdpCfg.parameters) > 0)then
				
				local roleRecruitBar = GUIManager.inst:GetWindowCs(typeof(CS.RoleRecruitBarView),false)

				if roleRecruitBar ~= nil and roleRecruitBar.isShowing then
					roleRecruitBar:clickRefreshMethod(1)
				end

			else

				local funcGeneric = xlua.get_generic_method(CS.EventController, "TriggerEvent_Lua2")
				local func = funcGeneric(CS.System.String, CS.UnityEngine.Color)
				func(
					csEventControllerInst,
					csGameEventType.SHOWUI_TEXTMSGTIP,
					CS.LanguageManager.inst:GetValueByKey("刷新券不足，请前往活动或商城获取"),
					csGUIHelper.GetColorByColorHex("FFFFFF")
				)
				return

			end
		end

	end

end


function RoleRecruitBar_dlc:clear()

	self.isInitComp = false
	self:removeListeners()

end



-----------LuaBehaviour---------------------------------------------------------------------------------------------------------------------------------------

local roleRecruitBar_dlc

function awake()

	roleRecruitBar_dlc = RoleRecruitBar_dlc.new()
	roleRecruitBar_dlc:init(self.gameObject)

end

function onEnable()

end

function ondestroy()

	if roleRecruitBar_dlc ~= nil then
		roleRecruitBar_dlc:clear()
		roleRecruitBar_dlc = nil
	end

end