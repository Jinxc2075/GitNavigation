--WorkerGameCoinGiftsUI

require("const/Constants")
require("class")
require("ui/ViewBase")
require("utils/XLuaUtils")

local EventDispatcher = require("event/EventDispatcher")

local CS_type_ObjList = typeof(CS.ObjList)
local CS_type_LuaListItem = typeof(CS.LuaListItem)

local CS_EventControllerInst = CS.EventController.inst
local CS_GameEventType = CS.GameEventType

local CS_GameTimerInst = CS.GameTimer.inst
local CS_TimeUtils = CS.TimeUtils

local CS_WorldParConfigManagerInst = CS.WorldParConfigManager.inst
local CS_LanguageManagerInst = CS.LanguageManager.inst


WorkerGameCoinGiftsUI = class(ViewBase)

function WorkerGameCoinGiftsUI:ctor()
	self.viewID = Constants.ViewName.WorkerGameCoinGiftsUI
	WorkerGameCoinGiftsUI.super.init(self, self.viewID)
	self.sortingLayerName = "window"
	self.isShowResPanel = true
	self.topResPanelType = CS.TopPlayerShowType.activity_workerGame
end
------------------------------------------------


function WorkerGameCoinGiftsUI:initComp()
	local contentPane = self.contentPanel

	self.btn_mask = contentPane:GetButton("btn_mask")
	self.btn_close = contentPane:GetButton("btn_close")

	self.tx_countdown = contentPane:GetText("tx_countdown")
	self.tx_title = contentPane:GetText("tx_title")

	local objList = contentPane:GetObjByName("objList"):GetComponent(CS_type_ObjList).objList

	self.workerGameCoinGiftItems = {}

	for i = 0, objList.Count - 1 do

		self.workerGameCoinGiftItems[#self.workerGameCoinGiftItems + 1] = objList[i]:GetComponent(CS_type_LuaListItem)

	end
	
	self.uiAnimator = contentPane.uiAnimator

end


function WorkerGameCoinGiftsUI:onInit()

	self:initComp()
	self.timerId = 0

	self.btn_mask.onClick:AddListener(
		function ()
			self:hide()
		end)


	self.btn_close:ButtonClickTween(
		function ()
			self:hide()
		end)

end

function WorkerGameCoinGiftsUI:Refresh()

	self.workerGameCoinGiftItems[1]:SetData({freeFlag = true,data = nil})

end

function WorkerGameCoinGiftsUI:onShowed()

	self:setTimer()
	
	self.tx_title.text = Activity_WorkerGameProxy.inst:GetActivityStr(MsgType.EOperatingActivityStringType.PurchaseTitle)
	
	self.workerGameCoinGiftItems[1]:SetData({freeFlag = true,data = nil})

	local datas = Activity_WorkerGameProxy.inst.coinGiftsData
	
	for i = 2, #self.workerGameCoinGiftItems do
		self.workerGameCoinGiftItems[i]:SetData({freeFlag = false,data = datas[i -1]}) --todo
	end
	
end

function WorkerGameCoinGiftsUI:onHide()

	self:clearTimer()
	
end


function WorkerGameCoinGiftsUI:DoShowAnimation()

	self:onShowed()

	self.uiAnimator:CrossFade("show", 0);
	self.uiAnimator:Update(0);
	self.uiAnimator:Play("show");

end

function WorkerGameCoinGiftsUI:DoHideAnimation()

	self.uiAnimator:Play("hide");
	local animLength = self.uiAnimator:GetClipLength("common_popUpUI_hide")

	CS_GameTimerInst:AddTimer(animLength,1,function ()
			self.uiAnimator:CrossFade("null", 0);
			self.uiAnimator:Update(0);
			self:HideView();
		end)

end


function WorkerGameCoinGiftsUI:setTimer()

	self:clearTimer()

	local remainTime = Activity_WorkerGameProxy.inst.endtime_serverEndtime - CS_GameTimerInst.serverNow
	self.tx_countdown.text = CS_LanguageManagerInst:GetValueByKey("距离商店关闭还有").."\n"..CS_TimeUtils.timeSpanStrip(remainTime,true)
	
	self.timerId = CS_GameTimerInst:AddTimer(1,function()
			local _remainTime = Activity_WorkerGameProxy.inst.endtime_serverEndtime - CS_GameTimerInst.serverNow
			self.tx_countdown.text = CS_LanguageManagerInst:GetValueByKey("距离商店关闭还有").."\n"..CS_TimeUtils.timeSpanStrip(_remainTime,true)
		end)

end

function WorkerGameCoinGiftsUI:clearTimer()

	if self.timerId ~= 0 then
		CS_GameTimerInst:RemoveTimer(self.timerId)
		self.timerId = 0
	end

end

------------------------------------------------