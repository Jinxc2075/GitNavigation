--UnionTaskUIView

require("const/Constants")
require("class")
require("ui/ViewBase")
local EventDispatcher = require("event/EventDispatcher")

local CS_type_superList = typeof(CS.Mosframe.DynamicScrollView)

local CS_UserDataProxyInst = CS.UserDataProxy.inst
local CS_LanguageManagerInst = CS.LanguageManager.inst
local CS_GameTimerInst = CS.GameTimer.inst
local CS_TimeUtils = CS.TimeUtils
local CS_EventControllerInst = CS.EventController.inst
local CS_WorldParConfigManagerInst = CS.WorldParConfigManager.inst
local CS_GameEventType = CS.GameEventType

local CS_UnionTaskPopularityConfigManagerInst = CS.UnionTaskPopularityConfigManager.inst

UnionTaskUIView = class(ViewBase)

function UnionTaskUIView:ctor()
	self.viewID = Constants.ViewName.UnionTaskUIView
	UnionTaskUIView.super.init(self, self.viewID)
	self.sortingLayerName = "window"
	self.isShowResPanel = true
	self.topResPanelType = CS.TopPlayerShowType.selfUnionToken
end
------------------------------------------------

--[[

closeBtn
superList

--]]

function UnionTaskUIView:initComp()
	local contentPane = self.contentPanel

	self.closeBtn =  contentPane:GetButton("closeBtn");
	self.lvTx = contentPane:GetText("lvTx");
	self.renownLvTx = contentPane:GetText("renownLvTx")
	self.countdownTx = contentPane:GetText("countdownTx")
	self.renownSlider = contentPane:GetObjByName("unionRenownSlider"):GetComponent("Slider")
	self.renownSliderTx = contentPane:GetText("unionRenownSliderTips")
	self.deatilBtn = contentPane:GetButton("deatilBtn")

	local superList =  contentPane:GetObjByName("ItemList")
	self.superList = superList:GetComponent(CS_type_superList)
	
	self.otherTips = contentPane:GetObjByName("otherTips")
	self.otherlvTx = contentPane:GetText("otherLvTx")
	self.otherNameTx = contentPane:GetText("otherNameTx")
	self.otherNameTipsBtn = contentPane:GetButton("otherNameTipsBtn")

	self.uiAnimator = contentPane.uiAnimator
	
end


function UnionTaskUIView:onInit()

	self:initComp()

	self.countDownTimer = 0

	self.superList.itemRenderer = function(index,item)
		self:ListItemRenderer(index,item)
	end
	
	self.superList.itemUpdateInfo = function(index,item)
		self:ListItemRenderer(index,item)
	end
	
	self.closeBtn:ButtonClickTween(function ()
			self:closeBtnClick()
	end)
	
	self.deatilBtn:ButtonClickTween(function ()
			self:deatilBtnClick()
	end)
	
	self.otherNameTipsBtn.onClick:AddListener(function ()
			self:otherNameTipsBtnClick()
	end)


end


function UnionTaskUIView:onShowed()
	print("UnionTaskUIView onShowed")

	self:setButtonFlag()
	
	if CS_UserDataProxyInst.union_needRequest_Task == 1 then
		CS_UserDataProxyInst.union_needRequest_Task = 0
		CS_EventControllerInst:TriggerEvent(CS_GameEventType.UnionEvent.UNION_REQUEST_TASKLIST);
	else
		self:SetData()
	end
	

end

function UnionTaskUIView:DoShowAnimation()

	self:onShowed()

	self.uiAnimator:CrossFade("show", 0);
	self.uiAnimator:Update(0);
	self.uiAnimator:Play("show");

end

function UnionTaskUIView:DoHideAnimation()

	self.uiAnimator:Play("hide");
	local animLength = self.uiAnimator:GetClipLength("commonBagUI_hide")

	CS_GameTimerInst:AddTimer(animLength,1,function ()
			self.uiAnimator:CrossFade("null", 0);
			self.uiAnimator:Update(0);
			self:HideView();
		end)

end


function UnionTaskUIView:setButtonFlag()
	
	local btnFlag = CS_WorldParConfigManagerInst:GetConfig(3002).parameters == 1;

	self.deatilBtn.gameObject:SetActive(btnFlag)
	
end

function UnionTaskUIView:SetData()

	if CS_UserDataProxyInst.unionTaskLevel <= 0 then
		CS.Logger.error("给定的公会悬赏等级错误: "..CS_UserDataProxyInst.unionTaskLevel)
		self:hide()
		return
	end
	
	self:SetTopInfo()
	
	self.superList.totalItemCount = CS_UserDataProxyInst.UnionTaskList.Count -- + 1

end

function UnionTaskUIView:SetTopInfo()

	self.lvTx.text = tostring(CS_UserDataProxyInst.unionTaskLevel)
	self.renownLvTx.text =  CS_LanguageManagerInst:GetValueByKey("每周名望<color=#ffc527>等级 {0}</color>",tostring(CS_UserDataProxyInst.unionTaskLevel))

	self:setTimer()


	if CS_UserDataProxyInst.unionTaskLevel == 10 then --满级了
		
		self.renownSlider.maxValue = 1
		self.renownSlider.value = 1
		self.renownSliderTx.text =  "max"
		
	else

		local curConfig = CS_UnionTaskPopularityConfigManagerInst:GetConfig(CS_UserDataProxyInst.unionTaskLevel)
		local nextConfig = CS_UnionTaskPopularityConfigManagerInst:GetConfig(CS_UserDataProxyInst.unionTaskLevel + 1)

		self.renownSlider.maxValue = nextConfig.need_point_num - curConfig.need_point_num
		self.renownSlider.value = CS_UserDataProxyInst.unionTaskPoint - curConfig.need_point_num
		self.renownSliderTx.text =  math.floor(self.renownSlider.value).."/<color=#4cd4ff>"..math.floor(self.renownSlider.maxValue).."</color>"

	end
end

function UnionTaskUIView:SetItemOtherInfo(uiTf,otherLv,otherName)
	
	self.otherlvTx.text = tostring(otherLv)
	self.otherNameTx.text = CS_LanguageManagerInst:GetValueByKey(otherName)
	self.otherTips.gameObject:SetActive(true)
	self.otherTips.transform.position = uiTf.position
	self.otherNameTipsBtn.gameObject:SetActive(true)
	
end

function UnionTaskUIView:shiftIn()
	self.contentObject:SetActive(true)
end

function UnionTaskUIView:shiftOut()
	self.contentObject:SetActive(false)
end

function UnionTaskUIView:closeBtnClick()
	self:hide()
end

function UnionTaskUIView:deatilBtnClick()
	EventDispatcher:dispatchEvent(GameEvent.UnionEvent.ShowUI_UnionRenownDetailUI)
end

function UnionTaskUIView:otherNameTipsBtnClick()
	self.otherTips:SetActive(false)
	self.otherNameTipsBtn.gameObject:SetActive(false)
end

function UnionTaskUIView:ListItemRenderer(index, item)
	item:SetData(index);
end

function UnionTaskUIView:setTimer()

	if(self.countDownTimer ~= 0) then
		CS_GameTimerInst:RemoveTimer(self.countDownTimer)
		self.countDownTimer = 0
	end

	self:timerMethod()
	self.countDownTimer = CS_GameTimerInst:AddTimer(1,function()
			self:timerMethod()
		end)

end

function UnionTaskUIView:onHide()
	
	if(self.countDownTimer ~= 0) then
		CS_GameTimerInst:RemoveTimer(self.countDownTimer)
		self.countDownTimer = 0
	end
	
	self.superList.totalItemCount = 0
	
end

function UnionTaskUIView:timerMethod()
	self.countdownTx.text = CS_TimeUtils.timeSpanStrip(CS_UserDataProxyInst.unionTaskRefreshTime,true)
end
------------------------------------------------