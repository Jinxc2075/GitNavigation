--UnionRenownDetailUI

require("utils/XLuaUtils")
require("const/Constants")
require("class")
require("ui/ViewBase")

local CS_type_superList = typeof(CS.Mosframe.DynamicScrollView)
local CS_type_ToggleGroupMarget = typeof(CS.ToggleGroupMarget)
local CS_type_ObjList = typeof(CS.ObjList)
local CS_EventControllerInst = CS.EventController.inst
local CS_GameEventType = CS.GameEventType
local CS_GameTimerInst = CS.GameTimer.inst
local CS_TimeUtils = CS.TimeUtils
local CS_UserDataProxyInst = CS.UserDataProxy.inst
local CS_LanguageManagerInst = CS.LanguageManager.inst
local CS_UnionTaskPopularityConfigManagerInst = CS.UnionTaskPopularityConfigManager.inst

UnionRenownDetailUI = class(ViewBase)

function UnionRenownDetailUI:ctor()
	self.viewID = Constants.ViewName.UnionRenownDetailUI
	UnionRenownDetailUI.super.init(self, self.viewID)
	self.sortingLayerName = "window"
	self.isShowResPanel = true
	self.topResPanelType = CS.TopPlayerShowType.selfUnionToken
end
------------------------------------------------

--[[

closeBtn
stateGroup
toggleLinkObjs

--]]

function UnionRenownDetailUI:initComp()

	local contentPane = self.contentPanel

	self.closeBtn =  contentPane:GetButton("closeBtn");
	self.stateGroup = contentPane:GetObjByName("stateGroup"):GetComponent(CS_type_ToggleGroupMarget)
	self.toggleLinkObjs = contentPane:GetObjByName("toggleLinkObjs"):GetComponent(CS_type_ObjList).objList
	self.topLvTx = contentPane:GetText("topLvTx")
	self.titleLvTx = contentPane:GetText("titleLvTx")
	self.awardSuperList = contentPane:GetObjByName("awardSuperList"):GetComponent(CS_type_superList)
	self.rankSuperList = contentPane:GetObjByName("rankSuperList"):GetComponent(CS_type_superList)
	self.countdownObj = contentPane:GetObjByName("countdownObj")
	self.countdownTx = contentPane:GetText("countdownTx")
	self.rankNothingObj = contentPane:GetObjByName("rankNothingTips")

	self.uiAnimator = contentPane.uiAnimator
	
end


function UnionRenownDetailUI:onInit()

	self:initComp()

	self.index = 0;
	self.rankList = {}
	self.timeId = 0;

	self.closeBtn:ButtonClickTween(
		function ()
			self:closeBtnClick()
		end
	)
	
	self.stateGroup.OnSelectedIndexValueChange = function (index)
		self:onSelectedIndexValueChange(index)
	end

	self.awardSuperList.itemRenderer = function(index,item)
		self:awardListItemRenderer(index,item)
	end

	self.awardSuperList.itemUpdateInfo = function(index,item)
		self:awardListItemRenderer(index,item)
	end


	self.rankSuperList.itemRenderer = function(index,item)
		self:rankListItemRenderer(index,item)
	end

	self.rankSuperList.itemUpdateInfo = function(index,item)
		self:rankListItemRenderer(index,item)
	end

end


function UnionRenownDetailUI:onHide()
	print("UnionRenownDetailUI onHide")
	self:clearTimer()
end

function  UnionRenownDetailUI:onShowed()
	print("UnionRenownDetailUI onShowed")
	
	self:setTimer()
	self.topLvTx.text = tostring(CS_UserDataProxyInst.unionTaskLevel)
	self.titleLvTx.text = CS_LanguageManagerInst:GetValueByKey("等级{0}",tostring(CS_UserDataProxyInst.unionTaskLevel))
	self.stateGroup:OnEnableMethod(self.index)

end

function UnionRenownDetailUI:DoShowAnimation()

	self:onShowed()

	self.uiAnimator:CrossFade("show", 0);
	self.uiAnimator:Update(0);
	self.uiAnimator:Play("show");

end

function UnionRenownDetailUI:DoHideAnimation()

	self.uiAnimator:Play("hide");
	local animLength = self.uiAnimator:GetClipLength("common_popUpUI_hide")

	CS_GameTimerInst:AddTimer(animLength,1,function ()
			self.uiAnimator:CrossFade("null", 0);
			self.uiAnimator:Update(0);
			self:HideView();
		end)

end


function UnionRenownDetailUI:shiftIn()
	self.contentObject:SetActive(true)
end

function UnionRenownDetailUI:shiftOut()
	self.contentObject:SetActive(false)
end

function UnionRenownDetailUI:closeBtnClick()
	self:hide()
end

function UnionRenownDetailUI:onSelectedIndexValueChange(index)

	self.index = index
	
	CS.AudioManager.inst:PlaySound(11)

	for i = 0,self.toggleLinkObjs.Count - 1 do
		self.toggleLinkObjs[i]:SetActive(false)
	end

	self.toggleLinkObjs[index]:SetActive(true)

	self.countdownObj:SetActive(index ~= 0)

	self:setState(index)

end

function  UnionRenownDetailUI:setState(index)

	if index == 0 then --提示信息

	elseif index == 1 then	--等级奖励详情

		self:setLevelDetailMess()

	elseif index == 2 then --排行榜

		self:setMemberRankMess()

	end

end

function UnionRenownDetailUI:setLevelDetailMess()

	local configs =  CS_UnionTaskPopularityConfigManagerInst:GetAllConfig()

	self.awardSuperList.totalItemCount = configs.Length 

end

function UnionRenownDetailUI:setMemberRankMess()

	self.rankSuperList.totalItemCount = 0

	CS_EventControllerInst:TriggerEvent(CS_GameEventType.UnionEvent.UNION_REQUEST_TASKRANKLIST)

	--测试
	--local list = get_csharp_list(CS.OneUnionRankData)
	--list:Add(CS.OneUnionRankData())
	--list:Add(CS.OneUnionRankData())
	--list:Add(CS.OneUnionRankData())


	--for i = 0, list.Count - 1 do

	--list[i].name = ""..(i+1)
	--list[i].point = (i + 1) * 10

	--end
	
	--list[1].userId = CS_UserDataProxyInst.playerData.userUid

	--self:getMemberRankList(list)
end

function UnionRenownDetailUI:getMemberRankList(rankList)

	if self.index ~= 2 then
		return
	end

	self.rankList = rankList
	self.rankSuperList.totalItemCount = rankList.Count
	self.rankNothingObj:SetActive(rankList.Count == 0)
	
end


function UnionRenownDetailUI:awardListItemRenderer(index, item)
	item:SetData(index + 1);
end

function UnionRenownDetailUI:rankListItemRenderer(index, item)
	item:SetData(self.rankList[index])
end

function UnionRenownDetailUI:setTimer()

	self:timerMethod()
	
	self.timeId = CS_GameTimerInst:AddTimer(1,function()
			self:timerMethod()
		end)

end

function UnionRenownDetailUI:timerMethod()
	self.countdownTx.text = CS_TimeUtils.timeSpanStrip(CS_UserDataProxyInst.unionTaskRefreshTime,true)
end

function  UnionRenownDetailUI:clearTimer()

	if 	self.timeId ~= 0 then

		CS_GameTimerInst:RemoveTimer(self.timeId)
		self.timeId = 0

	end

end

------------------------------------------------