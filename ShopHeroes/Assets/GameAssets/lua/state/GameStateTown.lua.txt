-- GameStateTown

require("class")
require("utils/XLuaUtils")
local BaseState = require("state/BaseState")
local coroutine_cs = require("coroutine_cs")

local csEventControllerInst = CS.EventController.inst
local csGameEventType = CS.GameEventType
local csSceneManager = CS.UnityEngine.SceneManagement.SceneManager
local EventDispatcher = require("event/EventDispatcher")
local csCityBuildingDataProxy = CS.CityBuildingDataProxy
local csIndoorMapEditSys = CS.IndoorMapEditSys
local csGameTimer = CS.GameTimer
local csAudioManager = CS.AudioManager
local csFGUI = CS.FGUI
local csManagerBinder = CS.ManagerBinder
local csUnityUtils = CS.UnityUtils
local CS_UserDataProxyInst = CS.UserDataProxy.inst
local CS_CameraMoveConfigManagerInst = CS.CameraMoveConfigManager.inst
local CS_LanguageManagerInst = CS.LanguageManager.inst


local GameStateTown = class(BaseState)

local startLoadScene = false

function GameStateTown:onEnter(transition)
	print("enter GameStateTown")
	CS.ManagerBinder.inst.mGameState = CS.kGameState.Town
	CS.GoOperationManager.inst.isInitShopperData = false
	csEventControllerInst:TriggerEvent(csGameEventType.CityBuildingEvent.CITYBUILDING_GET_DATA)
	--获取冒险槽位信息
	csEventControllerInst:TriggerEvent(csGameEventType.ExploreEvent.REQUEST_EXPLOREGROUPDATA)
	csEventControllerInst:TriggerEvent(csGameEventType.ExploreEvent.REQUEST_EXPLORESLOTDATA)
	--CS.TreasureBoxDataProxy.inst.isInit = false

	--获取公会相关数据
	if CS_UserDataProxyInst.playerData.hasUnion then
		--援助
		if CS_UserDataProxyInst.union_needRequest_MemberHelp == 1 then
			CS_UserDataProxyInst.union_needRequest_MemberHelp = 0
			csEventControllerInst:TriggerEvent(csGameEventType.UnionEvent.UNION_REQUEST_MEMBERHELPLIST)
		end
	end

	--设置相机高度
	CS.D2DragCamera.inst:updateCameMaxZoom(0, CS.kCameraMoveType.citySecene)
	--加载场景
	startLoadScene = false
	--csGameTimer.inst:StartCoroutine(loadIndoorMap());
	GameStateTown:loadIndoorMap()
end

function GameStateTown:loadIndoorMap()
	print("GameStateTown:loadIndoorMap")
	coroutine_cs.start(
		function()
			if (startLoadScene == false) then
				startLoadScene = true
				
				local aop = csManagerBinder.inst.mSceneMgr:loadScene("CityScene_light")
				coroutine.yield(aop)
				CS.AudioManager.inst:PlayMusic(3)
				csFGUI.inst:StartExcessAnimation(false, false)
				--重置英雄红点
				CS.RoleDataProxy.inst:ReSetHeroRedPoints()
				GUIManager.inst:OpenViewCS(typeof(CS.CityMainView))
				GUIManager.inst:OpenViewCS(typeof(CS.TopPlayerInfoView))
				coroutine_cs.wait(0.2)
				if
					CS.GuideDataProxy.inst ~= nil and CS.GuideDataProxy.inst.CurInfo ~= nil and
					CS.GuideDataProxy.inst.CurInfo.isAllOver
					then
					GUIManager.inst:OpenViewCS(
						typeof(CS.MainLineTaskView),
						function(view)
							CS.GoOperationManager.inst:setFingerTimeReset(true)
							local funcGeneric = xlua.get_generic_method(CS.EventController, "TriggerEvent")
							local func = funcGeneric(CS.System.Boolean)
							func(csEventControllerInst, csGameEventType.MainlineTaskEvent.REFRESHTASKDATA, false)
						end
					)
					EventDispatcher:dispatchEvent(GameEvent.GuideTask.ShowUI_GuideTask)
				end
				if HasMaxLevelHero then
					EventDispatcher:dispatchEvent(GameEvent.MsgTipEvent.ShowLuaTextTipUI,CS_LanguageManagerInst:GetValueByKey("英雄等级已达上限，需要升级英雄之家！"),CS.GUIHelper.GetColorByColorHex("#ffffff"),"jianzhu_jiuba",1)
					HasMaxLevelHero = false;
				end
				
				CS.ManagerBinder.inst.stateIsChanging = false
				
				EventDispatcher:dispatchEvent(GameEvent.OnSomeOneTaskFinishGameEvent.GoOnCommonTaskFinishProgressAnim)
			end
			CS.ManagerBinder.inst:GC()
		end
	)
end

function GameStateTown:onExit()
	print("exit GameStateTown")
	startLoadScene = false
	GUIManager.inst:HideViewCS(typeof(CS.CityMainView))
	GUIManager.inst:ClaerResidentView()
	csSceneManager.UnloadSceneAsync("CityScene_light")
	csEventControllerInst:TriggerEvent(csGameEventType.CityBuildingEvent.HUD_BUILDINGUPCLEAR)
	csEventControllerInst:TriggerEvent(csGameEventType.MainlineTaskEvent.HIDEMAINLINEUI)
	EventDispatcher:dispatchEvent(GameEvent.GuideTask.HideUI_GuideTask)
	CS.RoleDataProxy.inst:ClearHeroGraphicDressCache()
	--UIManager.inst:HideViewCS(typeof(CS.MainLineTaskView))
end

return GameStateTown
